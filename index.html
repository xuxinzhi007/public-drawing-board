<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šäººå®æ—¶åä½œç”»æ¿</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        h1 { text-align: center; color: #333; margin-bottom: 20px; }
        .tools { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        button, input { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; }
        button { background: #42b983; color: white; }
        button:hover { background: #359469; }
        #colorPicker { width: 50px; height: 35px; padding: 2px; }
        #lineWidth { width: 100px; }
        canvas {
            width: 100%;
            height: 600px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status { text-align: center; margin-top: 10px; color: #666; }
    </style>
</head>
<body>
<div class="container">
    <h1>å¤šäººå®æ—¶åä½œç”»æ¿ ğŸ¨</h1>
    <div class="tools">
        <button id="clearBtn">æ¸…ç©ºç”»æ¿</button>
        <input type="color" id="colorPicker" value="#000000">
        <label for="lineWidth">çº¿æ¡ç²—ç»†ï¼š</label>
        <input type="number" id="lineWidth" min="1" max="50" value="5">
    </div>
    <canvas id="drawingCanvas"></canvas>
    <div class="status">å½“å‰åœ¨çº¿ï¼š<span id="userCount">0</span> äºº | ç»˜ç”»æ•°æ®å®æ—¶åŒæ­¥ç»™æ‰€æœ‰ç”¨æˆ·</div>
</div>

<!-- å¼•å…¥ Pusher å…è´¹ SDKï¼ˆæ— éœ€æ³¨å†Œï¼Œç›´æ¥ä½¿ç”¨æµ‹è¯•å¯†é’¥ï¼‰ -->
<script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
<script>
    // 1. åˆå§‹åŒ– Pusherï¼ˆå…¬å…±æµ‹è¯•å¯†é’¥ï¼Œæ— éœ€æ³¨å†Œï¼Œé™åˆ¶ï¼šä»…æµ‹è¯•ç”¨ï¼Œè¿æ¥æ•°æœ‰é™ï¼‰
    const pusher = new Pusher('d83943006c30e905ff4e', {
        cluster: 'mt1',
        forceTLS: true
    });

    // 2. è®¢é˜…å…¬å…±é¢‘é“ï¼ˆæ‰€æœ‰ç”¨æˆ·å…±äº«åŒä¸€ä¸ªé¢‘é“ï¼Œå®ç°æ•°æ®å¹¿æ’­ï¼‰
    const channel = pusher.subscribe('public-drawing-board');
    let isDrawing = false;
    const canvas = document.getElementById('drawingCanvas');
    const ctx = canvas.getContext('2d');
    const colorPicker = document.getElementById('colorPicker');
    const lineWidth = document.getElementById('lineWidth');
    const userCountEl = document.getElementById('userCount');

    // 3. é€‚é… Canvas å°ºå¯¸
    function resizeCanvas() {
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // 4. ç»˜ç”»æ ¸å¿ƒé€»è¾‘
    function startDrawing(e) {
        isDrawing = true;
        draw(e, true); // åˆå§‹ç‚¹
    }

    function draw(e, isInit = false) {
        if (!isDrawing && !isInit) return;

        // è·å–é¼ æ ‡/è§¦æ‘¸åæ ‡
        let x, y;
        if (e.touches) { // è§¦æ‘¸è®¾å¤‡
            x = e.touches[0].clientX - canvas.getBoundingClientRect().left;
            y = e.touches[0].clientY - canvas.getBoundingClientRect().top;
        } else { // é¼ æ ‡è®¾å¤‡
            x = e.clientX - canvas.getBoundingClientRect().left;
            y = e.clientY - canvas.getBoundingClientRect().top;
        }

        // æœ¬åœ°ç»˜åˆ¶
        ctx.lineWidth = lineWidth.value;
        ctx.lineCap = 'round';
        ctx.strokeStyle = colorPicker.value;

        if (isInit) {
            ctx.beginPath();
            ctx.moveTo(x, y);
        } else {
            ctx.lineTo(x, y);
            ctx.stroke();
        }

        // 5. å‘æ‰€æœ‰ç”¨æˆ·å¹¿æ’­ç»˜ç”»æ•°æ®ï¼ˆä»…éåˆå§‹ç‚¹ï¼Œé¿å…é‡å¤ï¼‰
        if (!isInit) {
            channel.trigger('client-draw', {
                x, y,
                color: colorPicker.value,
                width: lineWidth.value,
                isInit: false
            });
        }
    }

    function endDrawing() {
        isDrawing = false;
        ctx.closePath();
    }

    // 6. ç›‘å¬æœ¬åœ°ç»˜ç”»äº‹ä»¶
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', endDrawing);
    canvas.addEventListener('mouseout', endDrawing);

    // è§¦æ‘¸è®¾å¤‡æ”¯æŒ
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault(); // é˜»æ­¢æ»šåŠ¨
        startDrawing(e);
    });
    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        draw(e);
    });
    canvas.addEventListener('touchend', endDrawing);
    canvas.addEventListener('touchcancel', endDrawing);

    // 7. ç›‘å¬å…¶ä»–ç”¨æˆ·çš„ç»˜ç”»å¹¿æ’­ï¼ˆåŒæ­¥ç»˜ç”»ï¼‰
    channel.bind('client-draw', (data) => {
        ctx.strokeStyle = data.color;
        ctx.lineWidth = data.width;
        ctx.lineCap = 'round';
        ctx.lineTo(data.x, data.y);
        ctx.stroke();
    });

    // 8. æ¸…ç©ºç”»æ¿åŠŸèƒ½ï¼ˆåŒæ­¥ç»™æ‰€æœ‰ç”¨æˆ·ï¼‰
    document.getElementById('clearBtn').addEventListener('click', () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        channel.trigger('client-clear', {}); // å¹¿æ’­æ¸…ç©ºæŒ‡ä»¤
    });

    // ç›‘å¬å…¶ä»–ç”¨æˆ·çš„æ¸…ç©ºæŒ‡ä»¤
    channel.bind('client-clear', () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    });

    // 9. åœ¨çº¿äººæ•°ç»Ÿè®¡ï¼ˆPusher è‡ªå¸¦åŠŸèƒ½ï¼‰
    channel.bind('pusher:subscription_count', (count) => {
        userCountEl.textContent = count;
    });

    // åˆå§‹åŒ–åœ¨çº¿äººæ•°
    pusher.connection.bind('connected', () => {
        userCountEl.textContent = channel.members.count;
    });

    // é”™è¯¯å¤„ç†
    pusher.connection.bind('error', (err) => {
        console.error('è¿æ¥é”™è¯¯ï¼š', err);
        alert('å®æ—¶è¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼');
    });
</script>
</body>
</html>